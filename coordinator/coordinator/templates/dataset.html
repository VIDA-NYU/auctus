{% extends "base.html" %}
{% set active_page = "dataset" %}

{% block contents %}
<h1>{{ metadata.name }}</h1>

{% if 'description' in metadata %}<p>{{ metadata.description }}</p>{% endif %}

<p><a href="{{ query_host }}/download/{{ dataset_id }}">Download: CSV</a>, <a href="{{ query_host }}/download/{{ dataset_id }}?format=d3m">D3M</a> ({{ size }})</p>

<script src="https://cdn.jsdelivr.net/npm/vega@5.9.1"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@4.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6.2.2"></script>

<script>
function setupPlot(elementId, plot) {
  var encoding = {
    "y": {
      "field": "count",
      "type": "quantitative",
      "title": null
    }
  };
  if(plot.type == 'histogram_numerical') {
    encoding.x = {
      "title": null,
      "bin": {"binned": true},
      "field": "bin_start",
      "type": "quantitative"
    };
    encoding.x2 = {
      "field": "bin_end"
    };
  } else if(plot.type == 'histogram_temporal') {
    encoding.x = {
      "title": null,
      "bin": {"binned": true},
      "field": "date_start",
      "type": "temporal",
      "utc": true
    };
    encoding.x2 = {
      "field": "date_end"
    };
  } else if(plot.type == 'histogram_categorical') {
    encoding.x = {
      "title": null,
      "bin": {"binned": true},
      "field": "bin",
      "type": "ordinal"
    };
  } else {
    console.log("Unknown plot type ", plot.type);
    return;
  }
  vegaEmbed(elementId, {
    "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
    "width": "container",
    "height": "120",
    "data": {
      "values": plot.data
    },
    "mark": "bar",
    "encoding": encoding
  }, {actions: false});
}
</script>

<div class="mb-3" style="overflow: auto; max-height: 40rem;"><table class="table table-bordered table-hover">
  <thead>
    <tr>
      {% for column in metadata.columns %}
      <th>{{ column.name }}</th>
      {% endfor %}
    </tr>
    <tr>
      {% macro semantic_type(type) %}
        {% set short_type = type.rsplit('/', 1)[-1] %}
        <span class="badge badge-pill semtype semtype-{{ short_type |lower }}">{{ short_type }}</span>
      {% endmacro %}
      {% for column in metadata.columns %}
      <th>
        <span class="badge badge-primary badge-pill">{{ column.structural_type.rsplit('/', 1)[-1] }}</span>
        {% for type in column.semantic_types %}{{ semantic_type(type) }}{% endfor %}
      </th>
      {% endfor %}
    </tr>
    <tr>
      {% for column in metadata.columns %}
      <td>
        {% if column.plot %}
          <div id="plot{{ loop.index0 }}" style="width: 100%;"></div>
          <script>
setupPlot('#plot{{ loop.index0 }}', {{ column.plot |tojson }});
          </script>
        {% endif %}
      </td>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% if sample %}
      {% for row in sample[1:] %}
        <tr>
        {% for cell in row %}
          <td>{{ cell }}</td>
        {% endfor %}
        </tr>
      {% endfor %}
    {% else %}
      <tr><td colspan="{{ metadata.columns |length }}">No sample available for this dataset.</td></tr>
    {% endif %}
  </tbody>
</table></div>

{% macro meta_table(m) -%}
  <table class="table table-bordered">
    <tbody>
      {%- for row in json_table(m) %}
      <tr>
        {%- for rowspan, cell in row %}
          {%- if loop.last %}
          <td colspan="{{ 100 - row|length }}">{{ cell }}</td>
          {%- else %}
          <th rowspan="{{ rowspan}}">{{ cell }}</th>
          {%- endif %}
        {%- endfor %}
      </tr>
      {%- endfor %}
    </tbody>
  </table>
{%- endmacro %}

<div id="spatial_coverage" style="display: none;">
<h2 id="spatial">Spatial Coverage Info</h2>
<p>This is the approximate spatial coverage of the data.</p>
</div>

<h2 id="metadata">Metadata</h2>
<p>This is the metadata that was recorded during profiling.</p>
{{ meta_table(metadata) }}

<h2 id="materialize">Materialization Info</h2>
<p>This was recorded by the discovery plugin <span style="font-family: monospace;">{{ discoverer }}</span></p>
{{ meta_table(materialize) }}

<script>
var spatial_coverage = '{{ spatial_coverage | tojson }}';
</script>
<script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList"></script>
<script src="{{ static_url('js/spatial.js') }}"></script>
{% endblock %}
